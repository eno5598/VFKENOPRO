<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KENO Loader ‚Äì ZIP entpacken (nur KENO, ohne Plus5)</title>
<style>
  :root{
    --bg:#0b0a18; --panel:#111327; --border:#242949; --muted:#2b2f51;
    --text:#e7e9f3; --accent:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:16px;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  .box{max-width:1100px;margin:0 auto}
  .panel{background:linear-gradient(180deg,#12142d,#0e1130);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0 0;box-shadow:0 8px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04)}
  .ph{display:flex;align-items:center;gap:10px;margin:0 0 8px}
  .emoji{font-size:22px}
  label{display:block;margin:4px 0 6px;font-size:14px;opacity:.9}
  input,select,button{font:inherit}
  input[type="file"],select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);background:#0b0f2a;color:var(--text)}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(135deg,#22c55e,#34d399);color:#062410}
  .secondary{background:#1b2144;color:var(--text);border:1px solid var(--muted)}
  .status{margin-top:8px;font-family:ui-monospace,Consolas,Menlo,monospace;background:#0b0f2a;border:1px solid var(--muted);border-radius:10px;padding:10px;white-space:pre-wrap}
  .small{font-size:12px;opacity:.9}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#0b0f2a;border:1px solid var(--muted);margin-left:6px;font-size:12px}
  canvas{width:100%;height:auto;background:#0b1226;border:1px solid var(--muted);border-radius:12px;box-shadow:inset 0 0 30px rgba(0,0,0,.5)}
</style>
</head>
<body>
<div class="box">

  <!-- 1) ARCHIV LADEN -->
  <div class="panel">
    <div class="ph"><span class="emoji">üóÇÔ∏è</span><h2 style="margin:0">Archiv laden (nur KENO)</h2></div>
    <div class="grid">
      <div>
        <label>Datei (ZIP/CSV/TXT)</label>
        <input type="file" id="file" accept=".zip,.csv,.txt">
        <div class="small" style="margin-top:6px">
          Offizielles ZIP: <a href="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_keno.zip" target="_blank" rel="noopener">archiv_keno.zip</a>
        </div>
      </div>
      <div>
        <label>Dominante L√§nge zulassen</label>
        <select id="lenAllow">
          <option value="auto" selected>Auto (5‚Äì20)</option>
          <option value="20">Nur 20 (klass. KENO)</option>
          <option value="10">Nur 10</option>
          <option value="any">Beliebig 5‚Äì20</option>
        </select>
      </div>
    </div>
    <div id="statusTop" class="status">Bereit. (Kein Archiv geladen)</div>
    <div id="diag" class="status" style="display:none"></div>
  </div>

  <!-- 2) MAP (Preview 1‚Äì70) -->
  <div class="panel">
    <div class="ph"><span class="emoji">üó∫Ô∏è</span><h2 style="margin:0">Map 1‚Äì70 (Preview)</h2></div>
    <canvas id="map" width="880" height="560"></canvas>
    <div class="small">Die Map dient hier nur als Lade-Check (Zahlenraster). Weitere Funktionen kannst du sp√§ter erg√§nzen.</div>
  </div>

</div>

<!-- ===== TEIL 2 hier einf√ºgen ===== -->
</body>
</html>
<script>
(function(){
"use strict";

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const text=(el,s)=>{ if(el) el.textContent=s; };
const html=(el,s)=>{ if(el) el.innerHTML=s; };
const fmt=n=>(n||0).toLocaleString("de-DE");
const uniqSorted=a=>Array.from(new Set(a)).sort((x,y)=>x-y);

/* ===== Persist ===== */
const LSK="keno_only_loader_v1";
let db=null, persistMode="localStorage";
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open("kenoOnlyDB",1);r.onupgradeneeded=()=>{const d=r.result;if(!d.objectStoreNames.contains("archive")) d.createObjectStore("archive");};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)});}
async function saveArchive(obj){
  try{ if(!db) db=await idbOpen(); const tx=db.transaction("archive","readwrite"); tx.objectStore("archive").put(obj,"main"); await new Promise((r,j)=>{tx.oncomplete=r;tx.onerror=()=>j(tx.error)}); persistMode="IndexedDB"; }
  catch{ localStorage.setItem(LSK, JSON.stringify(obj)); persistMode="localStorage"; }
}
async function loadArchive(){
  try{ if(!db) db=await idbOpen(); const tx=db.transaction("archive","readonly"); const req=tx.objectStore("archive").get("main");
    const val=await new Promise((r,j)=>{req.onsuccess=()=>r(req.result); req.onerror=()=>j(req.error)}); if(val) return val;
  }catch{}
  const raw=localStorage.getItem(LSK); return raw? JSON.parse(raw): null;
}

/* ===== State ===== */
let g_draws=[], g_drawSize=0;

/* ===== Map minimal ===== */
const map=$("#map"), ctx=map.getContext("2d");
function cellRect(n){const col=(n-1)%10,row=Math.floor((n-1)/10);const pad=8,cw=(map.width-pad*2)/10,ch=(map.height-pad*2)/7;return{x:pad+col*cw,y:pad+row*ch,w:cw,h:ch};}
function drawMap(){
  ctx.clearRect(0,0,map.width,map.height);
  ctx.strokeStyle="#223046";ctx.fillStyle="#dbeafe";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="14px ui-sans-serif,system-ui";
  for(let v=1;v<=70;v++){const r=cellRect(v);ctx.strokeRect(r.x,r.y,r.w,r.h);ctx.fillText(String(v), r.x+r.w/2, r.y+r.h/2);}
}

/* ===== Parser ===== */
function splitSmart(l){ if(/\t/.test(l))return l.split("\t"); if(l.includes(";"))return l.split(";"); if(l.includes("|"))return l.split("|"); if(/,/.test(l)&&!/^\d+(?:-\d+)+$/.test(l.trim()))return l.split(","); return l.trim().split(/\s+/); }
function parseTable(t){ return t.split(/\r?\n/).map(r=>r.trim()).filter(Boolean).map(splitSmart); }
function tryHeader(rows){
  const h=rows[0].map(x=>String(x).trim());
  const nIdx=[];
  for(let i=0;i<h.length;i++){
    const s=h[i];
    if(/^zahl\s*\d+$/i.test(s) || /^n(?:r|um)?\s*\d+$/i.test(s) || /^z\d+$/i.test(s)) nIdx.push(i);
  }
  if(nIdx.length>=5){
    const lists=[];
    for(let r=1;r<rows.length;r++){
      const nums=nIdx.map(i=>parseInt(String(rows[r][i]??"").replace(/[^\d-]+/g,"").trim(),10)).filter(Number.isInteger);
      if(nums.length) lists.push(nums);
    }
    return {lists,det:`Header erkannt (${nIdx.length} Zahl-Spalten)`};
  }
  return null;
}
function detectDashColumn(rows){
  let maxCols=0; for(const r of rows) if(r.length>maxCols) maxCols=r.length;
  let best=-1,score=-1;
  for(let c=0;c<maxCols;c++){
    let sc=0;
    for(const r of rows){
      if(c>=r.length) continue;
      const cell=String(r[c]??"").trim();
      if(/^\d+(?:-\d+){4,}$/.test(cell)) sc++;
    }
    if(sc>score){score=sc;best=c;}
  }
  return best>=0?best:null;
}
function scanMultiColumns(rows){
  const lists=[];
  for(let i=0;i<rows.length;i++){
    const flat=rows[i].join(" ").replace(/[^\d- ]+/g," ").replace(/\s+/g," ").trim();
    let nums=[];
    if(/^\d+(?:-\d+){4,}$/.test(flat)) nums=flat.split("-").map(x=>+x);
    else nums=(flat.match(/\b\d{1,3}\b/g)||[]).map(x=>+x);
    nums=nums.filter(n=>Number.isInteger(n)&&n>=1&&n<=70);
    if(nums.length>=5) lists.push(nums);
  }
  return {lists,det:"Multi-Spalten-Scan"};
}
function fallbackFree(raw){
  const out=[];
  for(const lnRaw of raw.split(/\r?\n/)){
    const ln=lnRaw.trim(); if(!ln) continue;
    if(/^\d+(?:-\d+){4,}$/.test(ln)){ out.push(ln.split("-").map(n=>parseInt(n,10))); continue; }
    const nums=(ln.match(/\b\d{1,3}\b/g)||[]).map(x=>parseInt(x,10)).filter(n=>n>=1&&n<=70);
    if(nums.length>=5) out.push(nums);
  }
  return {lists:out,det:"Freitext-Scan"};
}

/* ===== ZIP Handling ‚Äì NUR KENO ===== */
async function ensureJSZip(){
  if(window.JSZip) return;
  await new Promise((res,rej)=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";s.crossOrigin="anonymous";s.referrerPolicy="no-referrer";s.onload=res;s.onerror=()=>rej(new Error("JSZip laden fehlgeschlagen"));document.head.appendChild(s);});
}

/* Harte Filterregeln: include/exclude */
function isKenoPath(p){
  const q=p.toLowerCase();
  // Exclude alles, was nach plus/plus5 riecht
  if(/\bplus\b|\bplus5\b|_plus_|-plus-|\bplus\-5\b/.test(q)) return false;
  // Include KENO-Marker
  if(/\bkeno\b/.test(q)) return true;
  // Manche Zips haben nur ‚Äûarchiv‚Äú ‚Äì hier helfen wir uns mit CSV-Inhalt (sp√§ter)
  return false;
}

async function readZipKenoCsvs(file){
  await ensureJSZip();
  const ab=await file.arrayBuffer();
  const zip=await JSZip.loadAsync(ab);

  // 1) Kandidaten nach Pfadname vorfiltern (nur KENO, kein PLUS)
  let candidates=[];
  zip.forEach((path, entry)=>{
    const q=path.toLowerCase();
    if(!(q.endsWith(".csv")||q.endsWith(".txt"))) return;
    if(isKenoPath(path)) {
      const score=(/\bkeno\b/.test(q)?3:0)+(/\barchiv\b/.test(q)?2:0);
      candidates.push({path,entry,score,size:entry._dataUncompressedSize||0});
    }
  });

  // 2) Falls keine eindeutigen KENO-Treffer: als Fallback alle CSV/TXT au√üer PLUS5
  if(!candidates.length){
    zip.forEach((path, entry)=>{
      const q=path.toLowerCase();
      if(!(q.endsWith(".csv")||q.endsWith(".txt"))) return;
      if(/\bplus\b|\bplus5\b|_plus_|-plus-|\bplus\-5\b/.test(q)) return; // strikt raus
      const score=(/\bkeno\b/.test(q)?2:0)+(/\barchiv\b/.test(q)?1:0);
      candidates.push({path,entry,score,size:entry._dataUncompressedSize||0});
    });
  }

  if(!candidates.length) throw new Error("Keine KENO-CSV/TXT im ZIP gefunden (PLUS/PLUS5 ausgeschlossen).");

  // 3) Sortierung: Score, Gr√∂√üe, Pfad
  candidates.sort((a,b)=> b.score-b.score || b.size-b.size || (a.path<b.path?-1:1));

  // 4) Inhalte zusammenf√ºhren (manche Zips splitten Jahrg√§nge)
  let mergedText="";
  for(const c of candidates){
    let raw="";
    try{ raw=await c.entry.async("string"); }
    catch(_){ const u8=new Uint8Array(await c.entry.async("uint8array")); raw=new TextDecoder("utf-8").decode(u8); }
    mergedText += raw + "\n";
  }
  return {text:mergedText, chosen:candidates.map(c=>c.path)};
}

/* ===== Main: Datei w√§hlen ===== */
$("#file").addEventListener("change", ()=> handleAnyFile($("#file").files[0]));

async function handleAnyFile(file){
  if(!file){ text($("#statusTop"),"Keine Datei gew√§hlt."); return; }
  const name=(file.name||"").toLowerCase();
  $("#diag").style.display="none";
  text($("#statusTop"),`Lese Datei: ${file.name}`);

  try{
    let raw="", chosen=[];
    if(name.endsWith(".zip")){
      const r=await readZipKenoCsvs(file);
      raw=r.text; chosen=r.chosen;
      text($("#statusTop"),`ZIP entpackt. KENO-Dateien (${chosen.length}):\n‚Ä¢ `+chosen.join("\n‚Ä¢ "));
    }else{
      raw=await file.text();
      text($("#statusTop"),`Datei gelesen: ${file.name}`);
    }
    parseAndApply(raw, name);
  }catch(e){
    showDiag("Lesefehler", e?.message||String(e));
  }
}

function showDiag(title,msg){
  const box=$("#diag");
  box.style.display="";
  box.textContent = `[${title}] ${msg}`;
}

function parseAndApply(raw, source){
  const rows=parseTable(raw);
  let lists=[], det="";

  const h=tryHeader(rows);
  if(h && h.lists.length){ lists=h.lists; det=h.det; }

  if(!lists.length){
    const c=detectDashColumn(rows);
    if(c!=null){
      const tmp=[];
      for(const r of rows){
        const cell=String(r[c]??"").trim();
        if(/^\d+(?:-\d+){4,}$/.test(cell)) tmp.push(cell.split("-").map(x=>+x));
      }
      if(tmp.length){ lists=tmp; det="Spalte ‚Äû1-4-‚Ä¶‚Äú"; }
    }
  }

  if(!lists.length){
    const ms=scanMultiColumns(rows);
    if(ms.lists.length){ lists=ms.lists; det=ms.det; }
  }

  if(!lists.length){
    const fb=fallbackFree(raw);
    if(fb.lists.length){ lists=fb.lists; det=fb.det; }
  }

  if(!lists.length) throw new Error("Keine g√ºltigen Zeilen >=5 Zahlen (1‚Äì70) gefunden.");

  // Dominante L√§nge ermitteln (oder erzwungen)
  const allow = $("#lenAllow").value;
  const lenCount=new Map();
  for(const a of lists){ if(a.length>=5 && a.length<=20) lenCount.set(a.length,(lenCount.get(a.length)||0)+1); }

  let bestLen=0,bestCnt=-1;
  if(allow==="20" || allow==="10"){
    bestLen = +allow; bestCnt = lenCount.get(bestLen)||0;
    if(bestCnt===0) showDiag("Hinweis","Es wurden keine Zeilen der L√§nge "+bestLen+" gefunden. Ich nehme trotzdem die h√§ufigste L√§nge.");
  }
  if(!bestLen){
    for(const [k,v] of lenCount.entries()){
      if($("#lenAllow").value==="auto" || $("#lenAllow").value==="any"){
        if(v>bestCnt){ bestCnt=v; bestLen=k; }
      }
    }
  }
  if(!bestLen) throw new Error("Keine Listenl√§nge 5‚Äì20 erkannt.");

  const draws=lists
    .filter(a=>a.length===bestLen)
    .map(a=>uniqSorted(a.filter(x=>Number.isInteger(x)&&x>=1&&x<=70)));

  if(!draws.length) throw new Error("Nach Filter (1‚Äì70, L√§ngencheck) keine Ziehungen √ºbrig.");

  g_draws=draws; g_drawSize=bestLen;
  saveArchive({draws:g_draws, drawSize:g_drawSize, savedAt:Date.now(), source:source||"Upload"});

  text($("#statusTop"),
    `Archiv geladen: ${fmt(g_draws.length)} Ziehungen ¬∑ Ziehungsl√§nge ${g_drawSize} ¬∑ Parser: ${det||"‚Äî"} ¬∑ Persistiert (${persistMode}).`
  );
  drawMap();
}

/* ===== Init: aus Persistenz laden ===== */
(async function init(){
  drawMap();
  try{
    const obj=await loadArchive();
    if(obj && obj.draws && obj.draws.length){
      g_draws=obj.draws; g_drawSize=obj.drawSize||0;
      text($("#statusTop"), `Archiv aus Speicher: ${fmt(g_draws.length)} Ziehungen ¬∑ L√§nge ${g_drawSize} ¬∑ Persistiert (${persistMode}).`);
    }
  }catch{
    // ignorieren, Fallback ist localStorage
  }
})();
})();
</script>