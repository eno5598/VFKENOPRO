<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KENO ‚Äì Muster, Gruppen-Map & Hot-Gruppen (stabil)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --border:#223046; --muted:#263041; --text:#e5e7eb;
    --accent:#22c55e; --accent2:#60a5fa; --warm:#fb923c; --danger:#ef4444;
    /* Fixe Farben je 10er Band */
    --band1:#22c55e;  /* 1-10  */
    --band2:#60a5fa;  /* 11-20 */
    --band3:#fb923c;  /* 21-30 */
    --band4:#f472b6;  /* 31-40 */
    --band5:#a78bfa;  /* 41-50 */
    --band6:#f59e0b;  /* 51-60 */
    --band7:#34d399;  /* 61-70 */
  }
  html,body{height:100%}
  body{margin:0;padding:16px;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  a{color:#93c5fd;text-decoration:none}
  .box{max-width:1180px;margin:0 auto}
  input[type="file"],input[type="number"],input[type="text"],select{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid var(--muted);background:var(--bg);color:var(--text)}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(135deg,#059669,#22c55e);color:#04110a}
  .secondary{background:#1f2937;color:var(--text);border:1px solid var(--muted)}
  .danger{background:#7f1d1d;color:#fee2e2;border:1px solid #991b1b}
  .ghost{background:transparent;border:1px dashed var(--muted);color:var(--text)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>div{flex:1 1 240px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0 0}
  .ph{display:flex;align-items:center;gap:10px;margin:0 0 8px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--muted);background:var(--bg);margin-left:8px}
  .status{margin-top:8px;font-family:ui-monospace,Consolas,Menlo,monospace;background:var(--bg);border:1px solid var(--muted);border-radius:10px;padding:10px;white-space:pre-wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
  .results{margin-top:10px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .resItem{display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:var(--bg);border:1px solid var(--muted);border-radius:10px;padding:8px;margin-bottom:6px}
  .genWrap{display:grid;grid-template-columns:1fr 360px;gap:12px}
  @media (max-width:980px){ .genWrap{grid-template-columns:1fr} }
  /* Map */
  .numMap{display:grid;grid-template-columns:repeat(10,minmax(28px,1fr));gap:4px;user-select:none}
  .tile{position:relative;border:1px solid var(--muted);border-radius:6px;padding:6px;text-align:center;font-weight:700;background:var(--bg);font-size:13px;line-height:1}
  .tile.sel{outline:2px solid var(--accent2)}
  .tile .grpLayer{position:absolute;left:0;top:0;right:0;bottom:0;border-radius:6px;opacity:.28;pointer-events:none}
  .hint{opacity:.8}
  /* Chips (Muster) */
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--bg);border:1px solid var(--muted);border-radius:999px;padding:4px 6px}
  .chip .val{min-width:18px;text-align:center}
  .chip button{padding:4px 8px;border-radius:999px;font-weight:800;line-height:1}
</style>
</head>
<body>
<div class="box">

  <!-- üóÇÔ∏è Archiv -->
  <div class="panel" id="p-archiv" style="border-left:6px solid var(--accent2)">
    <div class="ph"><span>üóÇÔ∏è</span><h2 style="margin:0">Archiv laden</h2><span class="pill">ZIP wird lokal entpackt</span></div>
    <p class="hint">
      Offizielles Archiv (manuell laden & hier ausw√§hlen):
      <a href="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_keno.zip" target="_blank" rel="noopener">archiv_keno.zip</a>
    </p>
    <div class="row">
      <div>
        <label>CSV/TXT oder ZIP ausw√§hlen</label>
        <input type="file" id="file" accept=".csv,.txt,.zip,text/csv,application/zip,application/octet-stream,text/plain">
        <div class="hint">Erkannt: ‚ÄûZahl1..Zahl20‚Äú, Spalte ‚Äû1-4-‚Ä¶‚Äú oder freie Zahlzeilen.</div>
      </div>
      <div>
        <label>Archiv-Status</label>
        <div id="statusTop" class="status">Bereit. (Kein Archiv geladen)</div>
        <div class="row" style="margin-top:6px"><button id="clearCache" class="danger">Archiv l√∂schen</button></div>
      </div>
    </div>
  </div>

  <!-- üéõÔ∏è Einstellungen -->
  <div class="panel" id="p-settings" style="border-left:6px solid var(--accent)">
    <div class="ph"><span>üéõÔ∏è</span><h2 style="margin:0">Einstellungen</h2></div>
    <div class="row">
      <div>
        <label>Kombi-Gr√∂√üe (KENO-Typ)</label>
        <select id="kenoType">
          <option value="2">Typ 2</option><option value="3">Typ 3</option><option value="4">Typ 4</option>
          <option value="5">Typ 5</option><option value="6" selected>Typ 6</option><option value="7">Typ 7</option>
          <option value="8">Typ 8</option><option value="9">Typ 9</option><option value="10">Typ 10</option>
        </select>
      </div>
      <div><label>Max. erlaubte √úberschneidung</label><input type="number" id="maxOv" value="5" min="0" max="20"></div>
      <div><label>Zahlenbereich ‚Äì Von</label><input type="number" id="rangeFrom" value="1" min="1" max="200"></div>
      <div><label>Zahlenbereich ‚Äì Bis</label><input type="number" id="rangeTo" value="70" min="1" max="200"></div>
    </div>
  </div>

  <!-- üß© Muster -->
  <div class="panel" id="p-pattern" style="border-left:6px solid var(--warm)">
    <div class="ph"><span>üß©</span><h2 style="margin:0">Muster-Abst√§nde</h2><span class="pill">S = Abst√§nde + 1</span></div>
    <label><input type="checkbox" id="usePattern"> Muster verwenden</label>
    <div id="patternBox" style="display:none">
      <label>Aktuelles Muster (read-only)</label>
      <div id="gapLine" class="status">[ ]</div>
      <div class="chips" id="chips"></div>
      <div class="hint">Ergebnis: <span id="sOut" class="pill">S = 1 Zahl</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <button id="gapAdd" class="secondary">Ôºã Abstand</button>
        <button id="gapRemove" class="danger">Ôºç Abstand</button>
        <button id="gapClear" class="danger">‚úñÔ∏è Alles l√∂schen</button>
        <button id="gapRand" class="ghost">üé≤ Zuf√§llig</button>
        <button id="gapShuffle" class="ghost">üîÄ Mischen</button>
        <button id="gapReverse" class="ghost">‚ÜîÔ∏é Spiegeln</button>
      </div>
    </div>
  </div>

  <!-- üî• Hot-Gruppen -->
  <div class="panel" id="p-hot" style="border-left:6px solid #f472b6">
    <div class="ph"><span>üî•</span><h2 style="margin:0">Hot-Gruppen</h2></div>
    <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="useHotGroups"> aktivieren</label>
    <div id="hotBox" style="display:none">
      <div class="row">
        <div><label>R√ºckblick Ziehungen</label><input type="number" id="hotWindow" value="500" min="50" max="50000"></div>
        <div><label>Gruppengr√∂√üe</label>
          <select id="hotK">
            <option value="2" selected>2 (Paare)</option>
            <option value="3">3 (Tripel)</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div><label>Top N</label><input type="number" id="hotTopN" value="30" min="5" max="1000"></div>
        <div><label>Modus</label><select id="hotMode"><option value="require" selected>M√ºssen enthalten</option><option value="prefer">Bevorzugen</option></select></div>
      </div>
      <div class="row">
        <div style="flex:2 1 180px"><label>Info</label><div id="hotInfo" class="status">inaktiv</div></div>
        <div style="flex:1 1 180px"><label>Fortschritt</label><progress id="hotProg" value="0" max="1" style="display:none"></progress></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="hotStart" class="secondary">Neu berechnen</button>
        <button id="hotCancel" class="danger" disabled>Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- üßÆ Generieren -->
  <div class="panel" id="p-gen" style="border-left:6px solid var(--accent2)">
    <div class="ph"><span>üßÆ</span><h2 style="margin:0">Kombinationen generieren</h2></div>
    <div class="row">
      <div><label>Wieviele Ergebnisse</label><input type="number" id="want" value="10" min="1" max="2000"></div>
      <div><label>Max. Versuche (Basis)</label><input type="number" id="tries" value="60000" min="1000" step="1000"></div>
      <div><label>Seed</label><input type="number" id="seed" value="1" min="0"></div>
    </div>

    <div class="panel" style="margin-top:10px">
      <div class="ph"><span>üß±</span><h3 style="margin:0">Gruppen (fixe 10er Farben)</h3>
        <span id="grpAssigned" class="pill" style="margin-left:auto">0/0 eingeteilt</span>
      </div>
      <div class="row">
        <div style="flex:1 1 200px">
          <label>Schema</label>
          <select id="grpScheme">
            <option value="10" selected>10er Gruppen</option>
            <option value="7">7er Gruppen</option>
            <option value="5">5er Gruppen</option>
            <option value="3">3er Gruppen</option>
            <option value="custom">Eigene Einteilung</option>
          </select>
        </div>
        <div style="flex:2 1 320px"><label>Hinweis</label><div class="status">F√ºr jede Gruppe gew√ºnschte Anzahl eintragen. 0 = verbieten. Leer lassen = egal.</div></div>
      </div>
      <div id="grpList" class="row"></div>
      <div class="row" id="grpCustomBtns" style="display:none">
        <button id="grpAdd" class="ghost">Ôºã Gruppe</button>
        <button id="grpClear" class="danger">Alle l√∂schen</button>
      </div>
    </div>

    <div class="genWrap">
      <div>
        <div class="row" style="margin-top:10px">
          <button id="go" class="primary">Generieren</button>
          <button id="save" class="secondary">Als CSV speichern</button>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:2 1 180px"><label>Generieren-Status</label><div id="genInfo" class="status">bereit</div></div>
          <div style="flex:1 1 180px"><label>Fortschritt</label><progress id="genProg" value="0" max="1" style="display:none"></progress></div>
        </div>
        <div class="row" style="margin-top:6px"><button id="genCancel" class="danger" disabled>Generieren abbrechen</button></div>
      </div>
      <div>
        <div id="mapWrap" class="panel" style="margin-top:0">
          <div class="ph"><span>üó∫Ô∏è</span><h3 style="margin:0">Live-Map</h3><span class="pill">zeigt getestete/gef. Tipps</span></div>
          <div id="map" class="numMap"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- üß† Tipp pr√ºfen -->
  <div class="panel" id="p-analyse" style="border-left:6px solid var(--accent)">
    <div class="ph"><span>üß†</span><h2 style="margin:0">Tipp analysieren</h2></div>
    <label>Dein Tipp (Zahlen mit Leerzeichen/Komma)</label>
    <input type="text" id="tipInput" placeholder="z. B. 10 11 16 22 24 44 48 49 50 52">
    <div class="row" style="margin-top:6px">
      <div><label>√úberschneidung z√§hlen ab (‚â•)</label><input type="number" id="thrA" value="5" min="1" max="20"></div>
      <div><label>2. Schwelle (optional, ‚â•)</label><input type="number" id="thrB" value="6" min="1" max="20"></div>
    </div>
    <div style="margin-top:6px" class="row">
      <button id="checkTip" class="secondary">Tipp analysieren</button>
    </div>
    <div id="tipStatus" class="status" style="display:none"></div>
  </div>

  <!-- üìã Ergebnisse -->
  <div class="panel" id="p-results">
    <div class="ph"><span>üìã</span><h2 style="margin:0">Ergebnisse</h2></div>
    <div id="results" class="results"></div>
    <div id="resultStatus" class="status" style="display:none;margin-top:10px"></div>
  </div>

</div>

<!-- JSZip (ZIP-Entpacken im Browser) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
(function(){
  "use strict";
  var $=function(s){ return document.querySelector(s); };
  function text(el,s){ if(el) el.textContent=s; }
  function html(el,s){ if(el) el.innerHTML=s; }
  function uniqSorted(a){ var set=Object.create(null), out=[]; for(var i=0;i<a.length;i++){ var v=a[i]; if(!set[v]){ set[v]=1; out.push(v);} } return out.sort(function(x,y){return x-y}); }
  function scrollToNode(n){ if(!n) return; try{ n.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_){ n.scrollIntoView(true); } }

  var CACHE_KEY="keno_archive_v3";
  var g_draws=[], g_drawSize=0;

  /* ===== Map ===== */
  function bandColor(n){
    if(n>=1 && n<=10) return 'var(--band1)';
    if(n>=11 && n<=20) return 'var(--band2)';
    if(n>=21 && n<=30) return 'var(--band3)';
    if(n>=31 && n<=40) return 'var(--band4)';
    if(n>=41 && n<=50) return 'var(--band5)';
    if(n>=51 && n<=60) return 'var(--band6)';
    return 'var(--band7)';
  }
  var mapNodes=[];
  function renderMap(){
    var map=$("#map"); map.innerHTML=""; mapNodes.length=0;
    var A=+$("#rangeFrom").value||1, B=+$("#rangeTo").value||70;
    var rules=buildGroupRules();
    for(var n=A;n<=B;n++){
      var hide=false;
      for(var r=0;r<rules.length;r++){ var rr=rules[r]; if(n>=rr.from && n<=rr.to && rr.desired===0){ hide=true; break; } }
      var div=document.createElement("div"); div.className="tile"; div.setAttribute("data-n", String(n));
      if(!hide){
        var lay=document.createElement("div"); lay.className="grpLayer"; lay.style.background=bandColor(n); div.appendChild(lay);
      }
      var label=document.createElement("div"); label.textContent=String(n); div.appendChild(label);
      map.appendChild(div); mapNodes.push(div);
    }
  }
  function highlightOnMap(nums){
    var set=Object.create(null); for(var i=0;i<nums.length;i++) set[nums[i]]=1;
    for(var t=0;t<mapNodes.length;t++){
      var tile=mapNodes[t]; var n=parseInt(tile.getAttribute("data-n"),10);
      if(set[n]) tile.classList.add("sel"); else tile.classList.remove("sel");
    }
  }

  /* ===== Gruppen ===== */
  var g_scheme="10"; var g_groups=[];
  function buildScheme(size){
    var A=+$("#rangeFrom").value||1, B=+$("#rangeTo").value||70;
    var list=[]; for(var s=A;s<=B;s+=size){ list.push({from:s, to:Math.min(B, s+size-1), desired:null}); } return list;
  }
  function setScheme(s){
    g_scheme=s;
    if(s==="custom"){ if(!g_groups.length) g_groups=[{from:1,to:10,desired:null}]; $("#grpCustomBtns").style.display=""; }
    else{ g_groups=buildScheme(parseInt(s,10)); $("#grpCustomBtns").style.display="none"; }
    renderGroupUI(); renderMap(); updateAssignedBadge();
  }
  function renderGroupUI(){
    var list=$("#grpList"); list.innerHTML="";
    for(var i=0;i<g_groups.length;i++){
      var g=g_groups[i], tag=g.from+"-"+g.to;
      var wrap=document.createElement("div"); wrap.style.flex="1 1 200px";
      wrap.innerHTML='<div class="status" style="display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid #0005;background:'+bandColor(g.from)+'"></span><strong>'+tag+'</strong><span style="margin-left:auto">Soll:</span></div><input type="number" min="0" placeholder="egal" value="'+(g.desired==null?"":g.desired)+'" data-i="'+i+'" class="grpDesired">';
      list.appendChild(wrap);
    }
  }
  function buildGroupRules(){
    var arr=[]; for(var i=0;i<g_groups.length;i++){ var g=g_groups[i]; arr.push({from:Math.min(g.from,g.to),to:Math.max(g.from,g.to),desired:(g.desired==null?null:Math.max(0, g.desired|0))}); } return arr;
  }
  function updateAssignedBadge(){
    var S=getS(); var rules=buildGroupRules(); var assigned=0;
    for(var i=0;i<rules.length;i++) assigned+= (rules[i].desired==null?0:rules[i].desired);
    $("#grpAssigned").textContent = assigned+"/"+S+" eingeteilt";
  }
  $("#grpScheme").addEventListener("change", function(e){ setScheme(e.target.value); });
  $("#grpList").addEventListener("input", function(e){
    var inp=e.target.closest?e.target.closest("input.grpDesired"):null; if(!inp || !inp.getAttribute) return;
    var i=parseInt(inp.getAttribute("data-i"),10); if(!(i>=0)) return;
    var v=String(inp.value).trim(); g_groups[i].desired = v==="" ? null : Math.max(0, (parseInt(v,10)||0));
    updateAssignedBadge(); renderMap();
  });
  $("#grpAdd").addEventListener("click", function(){
    var A=+$("#rangeFrom").value||1, B=+$("#rangeTo").value||70;
    var from=A, to=Math.min(B, A+9);
    if(g_groups.length){ from=g_groups[g_groups.length-1].to+1; to=Math.min(B, from+9); if(from>B){ from=B; to=B; } }
    g_groups.push({from:from, to:to, desired:null}); renderGroupUI(); renderMap(); updateAssignedBadge();
  });
  $("#grpClear").addEventListener("click", function(){ if(confirm("Alle eigenen Gruppen l√∂schen?")){ g_groups=[]; renderGroupUI(); renderMap(); updateAssignedBadge(); } });

  /* ===== KENO-Typ / Muster ===== */
  function getS(){ var s=parseInt($("#kenoType").value,10); if(isNaN(s)||s<2||s>10) s=6; return s; }
  function syncToKenoType(){ var Sval=getS(); $("#maxOv").value = Math.max(0,Sval-1); $("#thrA").value=Math.max(1,Sval-1); $("#thrB").value=Sval; ensurePatternSize(); updateAssignedBadge(); }
  $("#kenoType").addEventListener("change", syncToKenoType);

  var g_pattern=[];
  function ensurePatternSize(){
    var need=getS()-1;
    if(g_pattern.length!==need){
      if(g_pattern.length<need) while(g_pattern.length<need) g_pattern.push(1);
      else g_pattern = g_pattern.slice(0,need);
      renderPattern();
    }
  }
  function renderPattern(){
    $("#gapLine").textContent = g_pattern.length ? "[ "+g_pattern.join(", ")+" ]" : "[ ]";
    $("#sOut").textContent = "S = "+(g_pattern.length+1)+" Zahlen";
    var chips=$("#chips"); chips.innerHTML="";
    for(var i=0;i<g_pattern.length;i++){
      var v=g_pattern[i];
      var el=document.createElement("span");
      el.className="chip";
      el.innerHTML = '<button class="secondary" data-act="dec" data-idx="'+i+'">‚àí</button><span class="val">'+v+'</span><button class="secondary" data-act="inc" data-idx="'+i+'">Ôºã</button>';
      chips.appendChild(el);
    }
  }
  function togglePatternBox(){ var on=$("#usePattern").checked; $("#patternBox").style.display=on?"":"none"; }
  $("#usePattern").addEventListener("change", togglePatternBox);
  $("#chips").addEventListener("click", function(e){
    var btn=e.target.closest?e.target.closest("button[data-act]"):null; if(!btn) return;
    var i=+btn.getAttribute("data-idx"), act=btn.getAttribute("data-act");
    if(!(i>=0) || i>=g_pattern.length) return;
    if(act==="inc") g_pattern[i]+=1;
    else if(act==="dec") g_pattern[i]=Math.max(1,g_pattern[i]-1);
    renderPattern();
  });
  $("#gapAdd").addEventListener("click", function(){ g_pattern.push(1); renderPattern(); });
  $("#gapRemove").addEventListener("click", function(){ if(g_pattern.length){ g_pattern.pop(); renderPattern(); }});
  $("#gapClear").addEventListener("click", function(){ g_pattern=[]; renderPattern(); });
  function shuffle(a){ var b=a.slice(); for(var i=b.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=b[i]; b[i]=b[j]; b[j]=t; } return b; }
  $("#gapRand").addEventListener("click", function(){ var need=getS()-1; g_pattern=[]; for(var i=0;i<need;i++) g_pattern.push(1+Math.floor(Math.random()*6)); renderPattern(); $("#usePattern").checked=true; togglePatternBox(); });
  $("#gapShuffle").addEventListener("click", function(){ if(!g_pattern.length) return; g_pattern=shuffle(g_pattern); renderPattern(); });
  $("#gapReverse").addEventListener("click", function(){ if(!g_pattern.length) return; g_pattern=g_pattern.slice().reverse(); renderPattern(); });

  /* ===== Archiv Parser (robust) ===== */
  function splitSmart(line){
    if(/\t/.test(line)) return line.split("\t");
    if(line.indexOf(";")>=0) return line.split(";");
    if(line.indexOf("|")>=0) return line.split("|");
    if(/,/.test(line) && !/^\d+(?:-\d+)+$/.test(line.replace(/\s+/g,""))) return line.split(",");
    return line.trim().split(/\s+/);
  }
  function parseTable(text){
    var rows=text.split(/\r?\n/), out=[];
    for(var r=0;r<rows.length;r++){ var ln=rows[r].trim(); if(!ln) continue; out.push(splitSmart(ln)); }
    return out;
  }
  function tryZahlHeader(rows){
    if(!rows.length) return null;
    var header=rows[0], idx=[];
    for(var i=0;i<header.length;i++){
      var h=String(header[i]||"").trim();
      if(/(gewinn)?\s*zahl\s*[_\.\-\s]*\d+$/i.test(h) || /^z\s*[_\.\-\s]*\d+$/i.test(h) || /^zahl\s*\d+$/i.test(h)){
        idx.push(i);
      }
    }
    if(idx.length>=5){
      var lists=[]; 
      for(var r=1;r<rows.length;r++){
        var row=rows[r], nums=[];
        for(var j=0;j<idx.length;j++){ var v=parseInt(String(row[idx[j]]||"").trim(),10); if(!isNaN(v)) nums.push(v); }
        if(nums.length) lists.push(nums);
      }
      return {lists:lists, info:"Header erkannt ("+idx.length+" Zahl-Spalten)"};
    }
    return null;
  }
  function detectDashCol(rows){
    var maxCols=0; for(var r=0;r<rows.length;r++) if(rows[r].length>maxCols) maxCols=rows[r].length;
    var best=-1,score=-1;
    for(var c=0;c<maxCols;c++){
      var sc=0;
      for(var r=0;r<rows.length;r++){
        var row=rows[r]; if(c>=row.length) continue;
        var cell=String(row[c]||"").trim(); if(!cell) continue;
        var parts=cell.split("-"); var ok=true;
        if(parts.length>=5){
          for(var k=0;k<parts.length;k++){ if(!/^\d+$/.test(parts[k].trim())){ ok=false; break; } }
          if(ok) sc++;
        }
      }
      if(sc>score){score=sc;best=c;}
    }
    return best;
  }
  function detectBestNumericBlock(rows){
    if(!rows.length) return null;
    var maxCols=0; for(var r=0;r<rows.length;r++) if(rows[r].length>maxCols) maxCols=rows[r].length;
    var scores=[], c; for(c=0;c<maxCols;c++) scores[c]=0;
    for(var r=1;r<rows.length;r++){
      var row=rows[r];
      for(c=0;c<maxCols;c++){
        var cell = row[c]; cell = cell==null? "": String(cell).trim();
        if(/^\d{1,3}$/.test(cell)){
          var v=parseInt(cell,10);
          if(v>=1 && v<=70) scores[c]++;
        }
      }
    }
    var best=null, size, start;
    for(size=20; size>=5; size--){
      for(start=0; start+size<=maxCols; start++){
        var sumScore=0; for(c=start;c<start+size;c++) sumScore+=scores[c];
        if(sumScore>0 && (!best || sumScore>best.sum || (sumScore===best.sum && size>best.size))){
          best={start:start, size:size, sum:sumScore};
        }
      }
      if(best && best.size===20) break;
    }
    return best;
  }
  function fallbackExtract(raw){
    var out=[], lines=raw.split(/\r?\n/);
    for(var i=0;i<lines.length;i++){
      var ln=lines[i].trim(); if(!ln) continue;
      if(/^\d+(?:-\d+)+$/.test(ln)){
        var arr=ln.split("-"), nums=[];
        for(var j=0;j<arr.length;j++){ var vv=parseInt(arr[j],10); if(!isNaN(vv)) nums.push(vv); }
        if(nums.length>=5) out.push(nums);
        continue;
      }
      var tokens = ln.split(/[;,\t\| ]+/);
      var nums2=[], t;
      for(var k=0;k<tokens.length;k++){
        t=tokens[k].trim();
        if(t.indexOf(".")>=0) continue;
        var v2=parseInt(t,10);
        if(!isNaN(v2) && v2>=1 && v2<=70) nums2.push(v2);
      }
      if(nums2.length>=5){ out.push(nums2.length>=20? nums2.slice(0,20):nums2); continue; }
      var digs = ln.match(/\d+/g)||[], nums3=[];
      for(var m=0;m<digs.length;m++){ var vv3=parseInt(digs[m],10); if(vv3>=1 && vv3<=70) nums3.push(vv3); }
      if(nums3.length>=5) out.push(nums3.length>=20? nums3.slice(0,20):nums3);
    }
    return out;
  }
  function loadArchiveFromRawText(raw, sourceLabel){
    var rows=parseTable(raw);
    var lists=[], detected="", z, ncol;
    z=tryZahlHeader(rows);
    if(z){ lists=z.lists; detected=z.info; }
    else{
      ncol=detectDashCol(rows);
      if(ncol>=0){
        for(var r=0;r<rows.length;r++){
          var row=rows[r]; if(ncol>=row.length) continue;
          var cell=String(row[ncol]||"").trim(); if(!cell) continue;
          var parts=cell.split("-"); var ok=true; for(var p=0;p<parts.length;p++){ if(!/^\d+$/.test(parts[p].trim())){ ok=false; break; } }
          if(ok){ var a=[]; for(p=0;p<parts.length;p++){ a.push(parseInt(parts[p],10)); } lists.push(a); }
        }
        detected="Spalte 1-4-‚Ä¶";
      }else{
        var blk=detectBestNumericBlock(rows);
        if(blk){
          for(r=1;r<rows.length;r++){
            var row2=rows[r], arr=[];
            for(var c=blk.start;c<blk.start+blk.size;c++){
              var v=parseInt(String(row2[c]||"").trim(),10);
              if(!isNaN(v)) arr.push(v);
            }
            if(arr.length>=5) lists.push(arr);
          }
          detected="Kontiguer Block "+blk.size+" Spalten (Score="+blk.sum+")";
        }else{
          lists=fallbackExtract(raw);
          detected="Fallback: freie Zahlzeilen";
        }
      }
    }
    if(!lists.length) throw new Error("Keine g√ºltigen Zahlen erkannt.");
    var freq={}, i, a;
    for(i=0;i<lists.length;i++){ a=lists[i]; if(a.length>=5 && a.length<=20){ var L=a.length; freq[L]=(freq[L]||0)+1; } }
    var bestLen=0, bestCnt=-1, k;
    for(k in freq){ if(freq.hasOwnProperty(k)){ var v=freq[k]; var kk=parseInt(k,10); if(v>bestCnt){ bestCnt=v; bestLen=kk; } } }
    if(!bestLen) throw new Error("Keine Listen der L√§nge 5‚Äì20 erkannt.");
    g_drawSize=bestLen;
    g_draws=[];
    for(i=0;i<lists.length;i++){
      var arr=lists[i]; if(arr.length===g_drawSize){
        var cleaned=[]; for(var q=0;q<arr.length;q++){ var val=arr[q]; if(typeof val==="number" && !isNaN(val)) cleaned.push(val); }
        cleaned=uniqSorted(cleaned); if(cleaned.length) g_draws.push(cleaned);
      }
    }
    if(!g_draws.length) throw new Error("Nach Filter auf dominierende L√§nge keine Ziehungen √ºbrig.");
    try{ localStorage.setItem(CACHE_KEY, JSON.stringify({draws:g_draws, drawSize:g_drawSize, savedAt:(new Date()).getTime(), source:sourceLabel||""})); }catch(_){}
    text($("#statusTop"), "Archiv geladen: "+g_draws.length+" Ziehungen (Ziehungsgr√∂√üe "+g_drawSize+") ¬∑ "+detected+(sourceLabel?(" ¬∑ Quelle: "+sourceLabel):""));
  }
  async function handleAnyFile(file){
    if(!file) return;
    text($("#statusTop"), "Lese Datei: "+file.name);
    var name=file.name.toLowerCase();
    try{
      if(name.slice(-4)===".zip"){
        if(typeof JSZip==="undefined"){ alert("JSZip fehlt (CDN)"); return; }
        var ab = await file.arrayBuffer();
        var zip = await JSZip.loadAsync(ab);
        var candidates=[];
        zip.forEach(function(path, entry){
          var p=path.toLowerCase();
          if(p.slice(-4)===".csv" || p.slice(-4)===".txt"){
            var score=(/\bkeno\b/.test(p)?3:0)+(/\barchiv\b/.test(p)?2:0)+(p.slice(-4)===".csv"?1:0);
            candidates.push({path:path,entry:entry,score:score,size:entry._dataUncompressedSize||0});
          }
        });
        if(!candidates.length) throw new Error("Keine CSV/TXT im ZIP gefunden");
        candidates.sort(function(a,b){ return (b.score-a.score) || (b.size-a.size) || (a.path<b.path?-1:1); });
        var target=candidates[0];
        text($("#statusTop"), "Entpacke & lese: "+target.path);
        var raw="";
        try{ raw = await target.entry.async("string"); }
        catch(_){ var u8=new Uint8Array(await target.entry.async("uint8array")); raw=new TextDecoder("utf-8",{fatal:false}).decode(u8); }
        loadArchiveFromRawText(raw, "ZIP: "+target.path);
      }else{
        var txt = await file.text();
        loadArchiveFromRawText(txt, file.name||"Upload");
      }
      if($("#useHotGroups").checked) recomputeHotGroups();
    }catch(e){
      text($("#statusTop"), "Fehler beim Lesen: "+(e && e.message? e.message : e));
      g_draws=[]; g_drawSize=0;
    }
  }
  $("#file").addEventListener("change", function(){ var f=$("#file").files[0]; handleAnyFile(f); });
  $("#clearCache").addEventListener("click", function(){
    try{ localStorage.removeItem(CACHE_KEY); }catch(_){}
    g_draws=[]; g_drawSize=0; text($("#statusTop"), "Archiv gel√∂scht. Bitte Datei erneut laden."); $("#results").innerHTML=""; $("#resultStatus").style.display="none";
  });

  /* ===== Init ===== */
  (function(){
    try{
      var raw=localStorage.getItem(CACHE_KEY);
      if(raw){
        var obj=JSON.parse(raw)||{}; g_draws=obj.draws||[]; g_drawSize=obj.drawSize||0;
        if(g_draws.length){
          var ts=obj.savedAt?new Date(obj.savedAt):new Date();
          var src=obj.source?(" ¬∑ Quelle: "+obj.source):"";
          text($("#statusTop"), "Archiv aus Browser geladen: "+g_draws.length+" Ziehungen (Ziehungsgr√∂√üe "+g_drawSize+") ¬∑ gespeichert am "+ts.toLocaleDateString()+" "+ts.toLocaleTimeString()+src);
        }
      }
    }catch(_){}
    syncToKenoType();
    setScheme("10");
    renderMap();
  })();

  /* ===== Hot-Gruppen (k=2..5) ===== */
  var g_hotGroups=[], g_hotMeta={k:2,window:500,topN:30,mode:"require"};
  function toggleHotBox(){ var on=$("#useHotGroups").checked; $("#hotBox").style.display=on?"":"none"; text($("#hotInfo"), on?"bereit":"inaktiv"); if(on) recomputeHotGroups(); }
  $("#useHotGroups").addEventListener("change", toggleHotBox);
  ["hotWindow","hotK","hotTopN","hotMode"].forEach(function(id){ var el=document.getElementById(id); if(el) el.addEventListener("change", function(){ if($("#useHotGroups").checked) recomputeHotGroups(); }); });
  $("#hotStart").addEventListener("click", function(){ if($("#useHotGroups").checked) recomputeHotGroups(); });

  function combIter(arr,k,cb){
    var n=arr.length; if(k>n) return;
    var idx=[]; for(var i=0;i<k;i++) idx[i]=i;
    while(true){
      var c=[], j; for(j=0;j<k;j++) c[j]=arr[idx[j]];
      cb(c);
      var i=k-1;
      while(i>=0 && idx[i]===i+n-k) i--;
      if(i<0) break;
      idx[i]++;
      for(j=i+1;j<k;j++) idx[j]=idx[j-1]+1;
    }
  }
  function recomputeHotGroups(){
    if(!g_draws.length){ g_hotGroups=[]; text($("#hotInfo"),"aktiv: kein Archiv"); return; }
    var k=parseInt($("#hotK").value,10)||2;
    var topN=Math.max(5,Math.min(1000,+($("#hotTopN").value||30)));
    var win=Math.max(50,+($("#hotWindow").value||500)); if(win>g_draws.length) win=g_draws.length;
    var fromIdx=Math.max(0,g_draws.length-win);
    var slice=g_draws.slice(fromIdx);
    var counts=new Map(), total=slice.length, done=0, prog=$("#hotProg"); prog.style.display="";
    for(var d=0; d<slice.length; d++){
      combIter(slice[d], k, function(combo){
        var key=combo.join("-");
        counts.set(key,(counts.get(key)||0)+1);
      });
      done++; if(done%20===0) prog.value=done/Math.max(1,total);
    }
    var items=Array.from(counts.entries()).sort(function(x,y){ return (y[1]-x[1]) || (x[0]<y[0]?-1:1); });
    var top=items.slice(0,topN).map(function(it){ return {key:it[0], count:it[1]}; });
    g_hotGroups=top.map(function(it){ return it.key.split("-").map(function(x){return parseInt(x,10)}); });
    g_hotMeta={k:k,window:win, topN:topN, mode:($("#hotMode").value||"require")};
    prog.style.display="none";
    if(!top.length){ text($("#hotInfo"),"Keine Gruppen gefunden."); }
    else{
      var head=top[0].count;
      var lines=top.slice(0,10).map(function(it){return it.key+" √ó"+it.count}).join(" | ");
      $("#hotInfo").innerHTML = "Top "+top.length+" (k="+k+", R√ºckblick="+win+"): h√§ufigste = "+head+"<br><span>"+lines+(top.length>10?" | ‚Ä¶":"")+"</span>";
    }
  }
  function matchedHotGroups(arr){
    if(!g_hotGroups.length) return [];
    var set=Object.create(null); for(var i=0;i<arr.length;i++) set[arr[i]]=1;
    var hits=[], g;
    outer: for(var idx=0; idx<g_hotGroups.length; idx++){
      g=g_hotGroups[idx];
      for(var j=0;j<g.length;j++){ if(!set[g[j]]) continue outer; }
      hits.push(g.slice());
    }
    return hits;
  }

  /* ===== Generator (Random + Pattern + Gruppen + Hot) ===== */
  function buildDrawBits(A,B){
    function toBits(arr){ var bits=0; for(var i=0;i<arr.length;i++){ var v=arr[i]; if(v>=A&&v<=B){ bits |= (1<<(v-1)); } } return bits; }
    var list=[]; for(var d=0; d<g_draws.length; d++){ list.push(toBits(g_draws[d]).toString()); } return list;
  }
  function startGenerate(params){
    var drawsBits = params.drawsBits.map(function(s){ return parseInt(s,10); });
    var want=params.want|0, maxOv=params.maxOv|0, A=params.A|0, B=params.B|0, S=params.S|0;
    var rules=params.rules||[];
    var hotOn=!!params.hotOn, hotMode=params.hotMode||"require", hotGroups=params.hotGroups||[];
    var mode=params.mode, gaps=params.gaps||[];
    var outPrefer=[], outOther=[], tested=0;
    var triesTarget = params.triesTarget||60000;
    var seed=params.seed>>>0;
    function rnd(){ seed=(seed+0x6D2B79F5)>>>0; var r=((seed^(seed>>>15))|1); r=((r^(r>>>7))*61)|0; r=(r^(r>>>14))>>>0; return (r>>>0)/4294967296; }
    function sampleRange(){
      var n=B-A+1; if(S>n) return null;
      var a=[], i; for(i=0;i<n;i++) a[i]=A+i;
      for(i=0;i<n;i++){ var j=i+Math.floor(rnd()*(n-i)); var t=a[i]; a[i]=a[j]; a[j]=t; }
      a.length=S; a.sort(function(x,y){return x-y}); return a;
    }
    function toBits(arr){ var bits=0; for(var i=0;i<arr.length;i++){ bits |= (1<<(arr[i]-1)); } return bits; }
    function popcountUpTo(x,limit){ var c=0; while(x){ x&=(x-1); c++; if(c>limit) break; } return c; }
    function validAgainst(cb){
      for(var i=0;i<drawsBits.length;i++){ var db=drawsBits[i]; if(popcountUpTo(cb & db, maxOv) > maxOv) return false; }
      return true;
    }
    function groupsSatisfied(arr){
      var c=new Array(rules.length), i; for(i=0;i<rules.length;i++) c[i]=0;
      for(var k=0;k<arr.length;k++){
        var v=arr[k];
        for(i=0;i<rules.length;i++){ var r=rules[i]; if(v>=r.from && v<=r.to) c[i]++; }
      }
      for(i=0;i<rules.length;i++){ var want=rules[i].desired; if(want!=null && c[i]!==want) return false; }
      return true;
    }
    function containsHotGroup(arr){ if(!hotGroups || !hotGroups.length) return false; var set=Object.create(null); for(var i=0;i<arr.length;i++) set[arr[i]]=1; for(i=0;i<hotGroups.length;i++){ var g=hotGroups[i], ok=true; for(var j=0;j<g.length;j++){ if(!set[g[j]]){ ok=false; break; } } if(ok) return true; } return false; }

    $("#genProg").style.display=""; $("#genProg").value=0; var updates=0;

    if(mode==="pattern"){
      // Alle Startpunkte scannen, solange nicht zu gro√ü
      var inc=0,i;
      for(i=0;i<gaps.length;i++) inc+=gaps[i];
      var start=A, end=B-inc, total=Math.max(0,end-start+1), processed=0;
      for(var s=start; s<=end && (outPrefer.length+outOther.length)<want; s++){
        var seq=[s], cur=s;
        for(i=0;i<gaps.length;i++){ cur+=gaps[i]; seq.push(cur); }
        var cb=toBits(seq);
        if(validAgainst(cb) && groupsSatisfied(seq)){
          var hit = hotOn ? containsHotGroup(seq) : false;
          if(hotOn && hotMode==="require"){ if(hit) outPrefer.push(seq); }
          else if(hotOn && hotMode==="prefer"){ (hit?outPrefer:outOther).push(seq); }
          else outOther.push(seq);
        }
        processed++; updates++; if(updates>=500){ updates=0; $("#genProg").value = total? Math.min(1, processed/total):0; text($("#genInfo"), "Suche (Muster)‚Ä¶ "+processed+"/"+total); highlightOnMap(seq); }
      }
    }else{
      for(var t=0; t<triesTarget && (outPrefer.length+outOther.length)<want; t++){
        var cand=sampleRange(); if(!cand) break;
        var cb=toBits(cand);
        if(validAgainst(cb) && groupsSatisfied(cand)){
          var hit = hotOn ? containsHotGroup(cand) : false;
          if(hotOn && hotMode==="require"){ if(hit) outPrefer.push(cand); }
          else if(hotOn && hotMode==="prefer"){ (hit?outPrefer:outOther).push(cand); }
          else outOther.push(cand);
        }
        tested++; updates++; if(updates>=2000){ updates=0; $("#genProg").value = Math.min(1, tested/triesTarget); text($("#genInfo"), "Suche (Zufall)‚Ä¶ getestet="+tested+" ¬∑ gefunden="+(outPrefer.length+outOther.length)+"/"+want); highlightOnMap(cand); }
      }
    }

    var out=outPrefer.concat(outOther).slice(0,want);
    $("#genProg").style.display="none";
    if(!out.length){ $("#results").innerHTML = '<div class="hint">(keine Treffer ‚Äì Bereich/√úberschneidung/Gruppen/Hot lockern)</div>'; $("#resultStatus").style.display="none"; }
    else{
      var frag=document.createDocumentFragment();
      for(var ii=0;ii<out.length;ii++){
        var arr=out[ii]; var isHot = hotOn && matchedHotGroups(arr).length>0;
        var div=document.createElement("div"); div.className="resItem";
        div.innerHTML = '<span>Kombi '+(ii+1)+' ‚Üí '+arr.join(" ") + (isHot? ' <span class="pill" style="border-color:#f59e0b">HOT</span>':'' ) +'</span> <button class="secondary" data-show="'+arr.join(",")+'">üëÅÔ∏è Auf Map</button>';
        frag.appendChild(div);
      }
      $("#results").innerHTML=""; $("#results").appendChild(frag);
      $("#resultStatus").style.display=""; $("#resultStatus").textContent = "Ergebnisse: "+out.length+"/"+want+" ¬∑ Archiv: "+g_draws.length+" Ziehungen (Ziehungsgr√∂√üe "+g_drawSize+")";
      highlightOnMap(out[0]);
      scrollToNode(document.getElementById("p-results"));
    }
    $("#genInfo").textContent="fertig";
  }

  $("#results").addEventListener("click", function(e){
    var btn=e.target.closest? e.target.closest("button[data-show]") : null; if(!btn) return;
    var nums=btn.getAttribute("data-show").split(",").map(function(x){return parseInt(x,10)});
    highlightOnMap(nums);
    scrollToNode(document.getElementById("p-gen"));
  });

  $("#go").addEventListener("click", function(){
    if(!g_draws.length){ alert("Bitte Archiv laden"); return; }
    var A=+$("#rangeFrom").value,B=+$("#rangeTo").value,maxOv=+$("#maxOv").value;
    if(A>B){ alert("Bereich ‚ÄöVon‚Äò darf nicht gr√∂√üer als ‚ÄöBis‚Äò sein."); return; }
    var Ssize=parseInt($("#kenoType").value,10);
    var rules=buildGroupRules();
    var assigned=0; for(var i=0;i<rules.length;i++) assigned+= (rules[i].desired==null?0:rules[i].desired);
    if(assigned && assigned !== Ssize){ if(!confirm("Deine Gruppen ergeben "+assigned+"/"+Ssize+". Trotzdem starten?")) return; }

    var params={A:A,B:B,S:Ssize,maxOv:maxOv,drawsBits:buildDrawBits(A,B),want:+$("#want").value,triesTarget:+$("#tries").value,seed:(+$("#seed").value)>>>0,rules:rules,hotOn:$("#useHotGroups").checked,hotMode:($("#hotMode")?$("#hotMode").value:"require"),hotGroups:g_hotGroups.slice()};
    if($("#usePattern").checked && g_pattern.length===Ssize-1){ params.mode="pattern"; params.gaps=g_pattern.slice(); }
    else params.mode="random";

    text($("#genInfo"), "Starte‚Ä¶ ("+params.mode+")"); $("#results").innerHTML=""; $("#resultStatus").style.display="none"; renderMap(); startGenerate(params);
  });

  /* ===== Analyse ===== */
  function analyzeTipArray(arr){
    if(!g_draws.length){alert("Bitte Archiv laden");return;}
    var A=+$("#rangeFrom").value,B=+$("#rangeTo").value;
    var thrA=Math.max(1,Math.min(20, +($("#thrA").value||7)));
    var thrBVal=String($("#thrB").value||"").trim();
    var thrB=thrBVal? Math.max(1,Math.min(20, +thrBVal)) : null;
    var tip=[], i; for(i=0;i<arr.length;i++){ var v=arr[i]; if(v>=A&&v<=B) tip.push(v); } tip=uniqSorted(tip);
    var maxOvSeen=0,cA=0,cB=0,cFull=0;
    for(var d=0; d<g_draws.length; d++){
      var dr=g_draws[d], ii=0,j=0,ov=0;
      while(ii<tip.length && j<dr.length){
        if(tip[ii]===dr[j]){ov++;ii++;j++;}
        else if(tip[ii]<dr[j]) ii++; else j++;
      }
      if(ov>maxOvSeen) maxOvSeen=ov;
      if(ov>=thrA) cA++;
      if(thrB!==null && ov>=thrB) cB++;
      if(ov===tip.length) cFull++;
    }
    var hits=$("#useHotGroups").checked ? matchedHotGroups(tip) : [];
    var out=[];
    out.push("Tipp: "+tip.join(" "));
    out.push("S="+tip.length);
    out.push("Max √úberschneidung im Archiv = "+maxOvSeen+" (Einstellung maxOv = "+$("#maxOv").value+")");
    out.push("Ziehungen mit ‚â•"+thrA+": "+cA);
    if(thrB!==null) out.push("Ziehungen mit ‚â•"+thrB+": "+cB);
    out.push("Komplett enthalten: "+(cFull?("Ja ("+cFull+"x)"):"Nein"));
    out.push("Archiv: "+g_draws.length+" Ziehungen (Ziehungsgr√∂√üe "+g_drawSize+")");
    if(hits.length){ out.push("Hot-Treffer (k="+g_hotMeta.k+"): "+hits.slice(0,10).map(function(g){return "("+g.join("-")+")"}).join(", ")+(hits.length>10?" ‚Ä¶":"")); }
    $("#tipStatus").style.display=""; $("#tipStatus").innerHTML=out.join("<br>");
    scrollToNode(document.getElementById("p-analyse"));
    $("#tipInput").value=tip.join(" ");
    highlightOnMap(tip);
  }
  $("#checkTip").addEventListener("click", function(){
    if(!g_draws.length){alert("Bitte Archiv laden");return;}
    var raw=String($("#tipInput").value||"").trim();
    var nums=(raw.match(/\d+/g)||[]).map(function(x){ return parseInt(x,10); }).filter(function(x){ return !isNaN(x); });
    nums=uniqSorted(nums); if(!nums.length){alert("Kein g√ºltiger Tipp");return;} analyzeTipArray(nums);
  });

  // Init: set default scheme/map
  setScheme("10");
})();
</script>
</body>
</html>
