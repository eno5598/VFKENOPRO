<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KENO Analyzer ‚Äì Flexible Gruppen + Map</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --border:#223046; --muted:#263041;
    --text:#e5e7eb; --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444; --pink:#a78bfa;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:16px;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  .box{max-width:1200px;margin:0 auto}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0 0}
  .ph{display:flex;align-items:center;gap:10px;margin:0 0 8px}
  .emoji{font-size:22px}
  label{display:block;margin:4px 0 6px;font-size:14px;opacity:.9}
  input[type="file"],select,input[type="number"],input[type="text"],textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);
    background:var(--bg);color:var(--text);outline:none
  }
  textarea{min-height:64px;resize:vertical}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(135deg,#059669,#22c55e);color:#04110a}
  .secondary{background:#1f2937;color:var(--text);border:1px solid var(--muted)}
  .danger{background:#7f1d1d;color:#fee2e2;border:1px solid #991b1b}
  .muted{opacity:.8}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .status{margin-top:8px;font-family:ui-monospace,Consolas,Menlo,monospace;background:var(--bg);
          border:1px solid var(--muted);border-radius:10px;padding:10px;white-space:pre-wrap}
  progress{width:100%;height:14px;border-radius:8px;overflow:hidden;background:var(--bg);border:1px solid var(--muted)}
  progress::-webkit-progress-value{background:#22c55e}
  .results{margin-top:10px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .fc-line{border:1px solid var(--muted);border-radius:8px;padding:8px;margin-bottom:4px}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:var(--bg);border:1px solid var(--muted);margin-left:6px;font-size:13px}
  .chip{background:var(--bg);border:1px solid var(--muted);border-radius:999px;padding:4px 8px;margin:2px;display:inline-block}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .legend-item{display:flex;align-items:center;gap:6px;border:1px solid var(--muted);border-radius:8px;padding:4px 8px}
  .swatch{width:16px;height:16px;border-radius:4px;border:1px solid #0003}
  .mapWrap{display:flex;gap:16px;flex-wrap:wrap}
  .mapPanel{flex:1 1 420px;min-width:320px}
  canvas{width:100%;height:auto;background:#0d1426;border:1px solid var(--muted);border-radius:12px}
  .hint{font-size:13px;opacity:.85}
</style>
</head>
<body>
<div class="box">

  <!-- Archiv laden -->
  <div class="panel">
    <div class="ph"><span class="emoji">üóÇÔ∏è</span><h2 style="margin:0">Archiv laden</h2></div>
    <input type="file" id="file" accept=".csv,.txt,.zip">
    <div class="status hint">
      Offizielles ZIP (manuell laden & hier ausw√§hlen):
      <a href="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_keno.zip" target="_blank" rel="noopener">archiv_keno.zip</a>
    </div>
    <div id="statusTop" class="status">Bereit. (Kein Archiv geladen)</div>
  </div>

  <!-- Gruppen & Einstellungen -->
  <div class="panel">
    <div class="ph"><span class="emoji">üé®</span><h2 style="margin:0">Gruppen (3‚Äì7) & Einstellungen</h2></div>

    <div class="row">
      <div class="col" style="flex:2 1 380px">
        <label>Gruppenbereiche (Format: <b>start-end</b>, kommasepariert; Abdeckung 1‚Äì70, disjunkt)</label>
        <input id="groupRanges" type="text" placeholder="z. B. 1-10,11-20,21-33,34-70">
        <div class="row" style="margin-top:6px">
          <button class="secondary" id="preset7">Preset 7√ó10: 1-10,11-20,‚Ä¶,61-70</button>
          <button class="secondary" id="preset3">Preset 3 Zonen: 1-23,24-47,48-70</button>
          <button class="secondary" id="preset5">Preset 5: 1-12,13-24,25-36,37-52,53-70</button>
        </div>
        <div class="hint" style="margin-top:6px">Mindestens 3, h√∂chstens 7 Gruppen. Jede Zahl 1‚Äì70 muss genau in einer Gruppe liegen.</div>
      </div>
      <div class="col">
        <label>KENO-Typ (S)</label>
        <select id="kenoType">
          <option value="2">Typ 2</option>
          <option value="3">Typ 3</option>
          <option value="4">Typ 4</option>
          <option value="5">Typ 5</option>
          <option value="6" selected>Typ 6</option>
          <option value="7">Typ 7</option>
          <option value="8">Typ 8</option>
          <option value="9">Typ 9</option>
          <option value="10">Typ 10</option>
        </select>
      </div>
      <div class="col">
        <label>Zielzeit</label>
        <select id="target">
          <option value="300">‚âà 5 min</option>
          <option value="600" selected>‚âà 10 min</option>
          <option value="0">High-End (max)</option>
        </select>
      </div>
      <div class="col">
        <label>Top-Kandidaten anzeigen</label>
        <select id="topShow">
          <option value="12">12</option>
          <option value="24" selected>24</option>
          <option value="48">48</option>
          <option value="72">72</option>
        </select>
      </div>
    </div>

    <!-- Farben -->
    <div class="row" style="margin-top:10px" id="colorRow"></div>

    <div class="legend" id="legend"></div>
    <div id="groupStatus" class="status">Gruppen noch nicht validiert.</div>
  </div>

  <!-- Analyse + Map -->
  <div class="panel" id="p-analyse">
    <div class="ph"><span class="emoji">üß†</span><h2 style="margin:0">Analyse (flexible Gruppen + Hot-Paare)</h2></div>
    <div class="row" style="margin-bottom:8px">
      <button id="validate" class="secondary">Gruppen pr√ºfen</button>
      <button id="start" class="primary" disabled>Start</button>
      <button id="pause" class="secondary" disabled>Pause</button>
      <button id="resume" class="secondary" disabled>Weiter</button>
      <button id="stop" class="danger" disabled>Stopp</button>
      <button id="showFinal" class="secondary" disabled>Top 6 anzeigen</button>
    </div>

    <div class="mapWrap">
      <div class="mapPanel">
        <canvas id="map" width="840" height="560"></canvas>
        <div class="hint">Map: 1‚Äì70 in 10 Spalten √ó 7 Reihen ¬∑ Farben = Gruppen-Overlays (transparent). Punkte = Treffer der gerade angezeigten Kombinationen.</div>
      </div>
      <div class="mapPanel">
        <progress id="prog" value="0" max="1" style="display:none"></progress>
        <div id="status" class="status">bereit</div>
        <div id="results" class="results"></div>
      </div>
    </div>

    <div id="finalBlock" class="panel" style="display:none">
      <h3>üèÅ Finale 6 Vorschl√§ge</h3>
      <div id="finalCombos" class="grid"></div>
    </div>
  </div>

  <!-- Tipp-Analyse -->
  <div class="panel" id="p-tip">
    <div class="ph"><span class="emoji">üìù</span><h2 style="margin:0">Tipp-Analyse</h2></div>
    <input type="text" id="tipInput" placeholder="z. B. 10 11 22 24 48 52">
    <button id="checkTip" class="secondary" style="margin-top:6px">Tipp analysieren</button>
    <div id="tipStatus" class="status" style="display:none"></div>
  </div>

</div>

<!-- ======= TEIL 2 direkt HIER drunter einf√ºgen ======= -->
</body>
</html>
<script>
(function(){
"use strict";

/* ===== Helpers & Globals ===== */
const $ = s => document.querySelector(s);
const text = (el, s) => { if(el) el.textContent = s; };
const html = (el, s) => { if(el) el.innerHTML = s; };
const fmtInt = n => (n||0).toLocaleString("de-DE");

const CACHE_KEY_ARCH = "keno_flex_archive_v1";
const CACHE_KEY_GROUPS = "keno_flex_groups_v1";

let g_draws = [], g_drawSize = 0;
let g_groups = [];   // [{from:..,to:..,color,alpha}]
let g_colorInputs = [];
let worker=null, runState="idle", lastBest=[];

/* ===== Group helpers ===== */
const defaultPalette = ["#3b82f6","#22c55e","#f59e0b","#ef4444","#a78bfa","#14b8a6","#eab308"];
function hexWithAlpha(hex, a){
  const h = hex.replace("#","").trim();
  const r=parseInt(h.substring(0,2),16),
        g=parseInt(h.substring(2,4),16),
        b=parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}
function groupOfValue(v){
  for(let i=0;i<g_groups.length;i++) if(v>=g_groups[i].from && v<=g_groups[i].to) return i;
  return -1;
}

/* ===== Build color UI ===== */
function buildColorRow(){
  const wrap = $("#colorRow");
  html(wrap,"");
  g_colorInputs=[];
  (g_groups||[]).forEach((g,i)=>{
    const id = "col_"+i;
    const box = document.createElement("div");
    box.className="col";
    box.innerHTML = `
      <label>Gruppe ${i+1}: ${g.from}-${g.to}</label>
      <div class="row">
        <input type="color" id="${id}" value="${g.color}" style="flex:0 0 56px;height:42px;padding:4px">
        <input type="number" id="${id}_a" min="0" max="1" step="0.05" value="${g.alpha}" title="Transparenz (0‚Äì1)">
      </div>
    `;
    wrap.appendChild(box);
    g_colorInputs.push({c:$("#"+id), a:$("#"+id+"_a")});
  });
  updateLegend();
}
function updateLegend(){
  const L=$("#legend");
  const items=(g_groups||[]).map((g,i)=>`
    <div class="legend-item">
      <span class="swatch" style="background:${hexWithAlpha(g.color, g.alpha)};border-color:${g.color}"></span>
      <span>G${i+1}: ${g.from}-${g.to}</span>
    </div>
  `).join("");
  html(L, items);
}

/* ===== Parse groups ===== */
function parseRanges(str){
  const parts = String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
  const ranges=[];
  for(const p of parts){
    const m = p.match(/^(\d{1,2})\s*-\s*(\d{1,2})$/);
    if(!m) throw new Error(`Ung√ºltiges Segment: "${p}"`);
    let a=+m[1], b=+m[2];
    if(a>b) [a,b]=[b,a];
    if(a<1||b>70) throw new Error(`Au√üerhalb [1..70]: ${a}-${b}`);
    ranges.push({from:a,to:b});
  }
  ranges.sort((x,y)=> x.from-y.from || x.to-y.to);
  for(let i=1;i<ranges.length;i++){
    if(ranges[i].from <= ranges[i-1].to) throw new Error("√úberlappung in Gruppen");
  }
  if(ranges.length<3 || ranges.length>7) throw new Error("3‚Äì7 Gruppen erlaubt");
  if(ranges[0].from!==1 || ranges.at(-1).to!==70) throw new Error("Bereiche m√ºssen 1 starten und 70 enden");
  for(let i=1;i<ranges.length;i++){
    if(ranges[i].from !== ranges[i-1].to+1) throw new Error("L√ºcke zwischen Gruppen");
  }
  return ranges.map((r,i)=> ({...r, color: defaultPalette[i%defaultPalette.length], alpha:0.22}));
}
function validateGroups(){
  try{
    const ranges = parseRanges($("#groupRanges").value);
    if(g_groups.length===ranges.length){
      for(let i=0;i<ranges.length;i++){
        ranges[i].color = g_colorInputs[i]?.c?.value || ranges[i].color;
        ranges[i].alpha = parseFloat(g_colorInputs[i]?.a?.value ?? ranges[i].alpha);
      }
    }
    g_groups = ranges;
    buildColorRow();
    localStorage.setItem(CACHE_KEY_GROUPS, JSON.stringify(g_groups));
    $("#start").disabled=false;
    text($("#groupStatus"),"Gruppen OK ‚úì");
  }catch(e){
    $("#start").disabled=true;
    text($("#groupStatus"),"Fehler: "+(e?.message||e));
  }
}
$("#validate").addEventListener("click", validateGroups);

/* ===== Archive loading (gek√ºrzt wie gehabt) ===== */
// ... (unver√§ndert aus deiner Version, wegen L√§nge nicht wiederholt) ...
// ‚Üí L√§d Archiv in g_draws[], ruft redrawMap() am Ende auf

/* ===== Map Drawing ===== */
const map=$("#map"), ctx=map.getContext("2d");
function cellRect(n){
  const col=(n-1)%10, row=Math.floor((n-1)/10);
  const pad=8, cw=(map.width-pad*2)/10, ch=(map.height-pad*2)/7;
  return {x:pad+col*cw,y:pad+row*ch,w:cw,h:ch};
}
function redrawMap(highlights){
  ctx.clearRect(0,0,map.width,map.height);
  for(let i=0;i<g_groups.length;i++){
    const g=g_groups[i];
    ctx.fillStyle=hexWithAlpha(g.color,g.alpha);
    for(let v=g.from;v<=g.to;v++){ const r=cellRect(v); ctx.fillRect(r.x,r.y,r.w,r.h); }
  }
  ctx.strokeStyle="#1f2a44"; ctx.fillStyle="#cbd5e1"; ctx.font="14px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle";
  for(let v=1;v<=70;v++){ const r=cellRect(v); ctx.strokeRect(r.x,r.y,r.w,r.h); ctx.fillText(String(v),r.x+r.w/2,r.y+r.h/2); }
  if(Array.isArray(highlights)){
    for(const {num,rank} of highlights){
      const r=cellRect(num);
      ctx.beginPath(); ctx.arc(r.x+r.w/2,r.y+r.h/2,Math.min(r.w,r.h)*0.35,0,Math.PI*2);
      ctx.fillStyle=hexWithAlpha("#fff",0.08+0.12*(rank||0)); ctx.fill();
      ctx.beginPath(); ctx.arc(r.x+r.w/2,r.y+r.h/2,Math.min(r.w,r.h)*0.18,0,Math.PI*2);
      ctx.fillStyle="#e5e7eb"; ctx.fill(); ctx.strokeStyle="#0003"; ctx.stroke();
    }
  }
}

/* ===== Worker (mit Fixes) ===== */
function buildWorker(){
  if(worker) try{worker.terminate();}catch{}
  const code=`
  let CFG=null, STATE=null;
  const uniqSorted=a=>Array.from(new Set(a)).sort((x,y)=>x-y);

  function freq(draws){const f=Array(71).fill(0);for(const d of draws)for(const v of d)if(v>=1&&v<=70)f[v]++;return f;}
  function coMatrix(draws){const M=Array.from({length:71},()=>Array(71).fill(0));for(const d of draws){for(let i=0;i<d.length;i++)for(let j=i+1;j<d.length;j++){const a=d[i],b=d[j];if(a>=1&&a<=70&&b>=1&&b<=70){M[a][b]++;M[b][a]++;}}}return M;}
  function PMI(draws){const N=draws.length,f=freq(draws),co=coMatrix(draws);const p=Array(71).fill(0).map((_,i)=>i?(f[i]/(N||1)):0);const P=Array.from({length:71},()=>Array(71).fill(0));for(let a=1;a<=70;a++)for(let b=1;b<=70;b++){if(a===b){P[a][b]=0;continue;}const pab=co[a][b]/(N||1),den=(p[a]*p[b])||1e-12;P[a][b]=Math.log((pab||1e-12)/den);}return{P};}
  function gapHistogram(draws){const H=Array(70).fill(0);for(const d of draws){const s=d.slice().sort((a,b)=>a-b);for(let i=1;i<s.length;i++){const g=s[i]-s[i-1];if(g>=1&&g<=69)H[g]++;}}for(let i=2;i<=68;i++)H[i]=0.25*H[i-1]+0.5*H[i]+0.25*H[i+1];let mx=1;for(let i=1;i<=69;i++)if(H[i]>mx)mx=H[i];for(let i=1;i<=69;i++)H[i]/=mx||1;return H;}
  function baseProb(draws){const f=freq(draws),p=Array(71).fill(0);for(let i=1;i<=70;i++){p[i]=(f[i]+0.5);}let s=0;for(let i=1;i<=70;i++)s+=p[i];for(let i=1;i<=70;i++)p[i]/=s||1;return p;}

  // Score (fix: Gaps auf sortierter Kopie)
  function scoreOf(arr,ctx){const {P,gapW,pBase,grpTarget,grpIdx}=ctx;
    let sProb=0;for(const v of arr)sProb+=Math.log(Math.max(1e-12,pBase[v]));
    let sPair=0;for(let i=0;i<arr.length;i++)for(let j=i+1;j<arr.length;j++)sPair+=P[arr[i]][arr[j]];
    const srt=arr.slice().sort((a,b)=>a-b);let sGap=0;for(let i=1;i<srt.length;i++){const g=srt[i]-srt[i-1];if(g>=1&&g<=69)sGap+=gapW[g];}sGap/=Math.max(1,srt.length-1);
    const cg=Array(grpTarget.length).fill(0);for(const v of arr){const g=grpIdx[v];if(g>=0)cg[g]++;}let sGrp=0;for(let g=0;g<grpTarget.length;g++)sGrp+=-Math.abs((grpTarget[g]||0)-(cg[g]||0));
    let low=0,mid=0,high=0;for(const v of srt){if(v<=23)low++;else if(v<=47)mid++;else high++;}const bal=1-(Math.abs(low-mid)+Math.abs(mid-high)+Math.abs(low-high))/(2*arr.length);
    return 1.0*sProb+0.45*sPair+0.60*sGap+0.40*sGrp+0.20*bal;}

  function expandVariant(){const S=CFG.S;if(STATE.varIdx>=STATE.variants.length)return false;const target=STATE.variants[STATE.varIdx];const ctx={...STATE.ctxBase,grpTarget:target};
    let frontier=[{arr:[],used:new Uint8Array(71),need:target.slice(),score:0}];
    function nextGroupOrder(need){let bestG=0,bestV=-1;for(let g=0;g<need.length;g++){if(need[g]<=0)continue;let s=0;for(let i=0;i<Math.min(need[g],STATE.groupsList[g].length);i++)s+=STATE.rank[STATE.groupsList[g][i]];const v=need[g]*1000+s;if(v>bestV){bestV=v;bestG=g;}}return bestG;}
    for(let depth=0;depth<S;depth++){const next=[];for(const node of frontier){const g=nextGroupOrder(node.need);if(node.need[g]<=0)continue;let pushed=0;for(const v of STATE.groupsList[g]){if(node.used[v])continue;const need2=node.need.slice();need2[g]--;const used2=node.used.slice();used2[v]=1;const arr2=node.arr.concat(v);const sc=scoreOf(arr2,ctx);next.push({arr:arr2,used:used2,need:need2,score:sc});if(++pushed>=CFG.branchPerStep)break;}}next.sort((a,b)=>b.score-a.score||a.arr.length-b.arr.length);frontier=next.slice(0,CFG.beam);}
    for(const node of frontier){if(node.arr.length===S){const sorted=node.arr.slice().sort((a,b)=>a-b);const k=sorted.join("-");const val=STATE.best.get(k)||0;STATE.best.set(k,val+node.score);}}STATE.varIdx++;return true;}

  onmessage=e=>{const m=e.data;if(m.cmd==="start"){const draws=CFG.drawsAll=m.cfg.drawsAll;const pBase=baseProb(draws),gapW=gapHistogram(draws),{P}=PMI(draws);const grpIdx=Array(71).fill(-1);for(let g=0;g<m.cfg.groups.length;g++){for(let v=m.cfg.groups[g].from;v<=m.cfg.groups[g].to;v++)grpIdx[v]=g;}const rank=Array(71).fill(0);for(let v=1;v<=70;v++){let top=0;for(let u=1;u<=70;u++){if(u!==v)top=Math.max(top,P[v][u]);}rank[v]=Math.log(Math.max(1e-12,pBase[v]))+0.35*top;}const groupsList=m.cfg.groups.map(()=>[]);for(let v=1;v<=70;v++){const gi=grpIdx[v];if(gi>=0)groupsList[gi].push(v);}for(const g of groupsList)g.sort((a,b)=>rank[b]-rank[a]||a-b);
      STATE={startTime:performance.now(),targetSec:m.cfg.targetSec,iter:0,paused:false,stop:false,variants:m.cfg.groups.map(()=>Array()),varIdx:0,best:new Map(),ctxBase:{P,gapW,pBase,grpIdx},groupsList,rank};STATE.variants=[[...m.cfg.groups.map(()=>Math.floor(m.cfg.S/m.cfg.groups.length))]];tick();}
    else if(m.cmd==="pause"){if(STATE){STATE.paused=true;postMessage({type:"paused"});}}
    else if(m.cmd==="resume"){if(STATE){STATE.paused=false;postMessage({type:"resumed"});}}
    else if(m.cmd==="stop"){if(STATE){STATE.stop=true;}postMessage({type:"stopped"});}};
  function tick(){if(!STATE||STATE.stop)return;if(STATE.paused){setTimeout(tick,200);return;}const ok=expandVariant();STATE.iter++;if(STATE.iter%1===0){const best=Array.from(STATE.best.entries()).sort((a,b)=>b[1]-a[1]).slice(0,60).map(([k,score])=>({k,score}));let max=best.length?best[0].score:1;const out=best.map(x=>({k:x.k,idx:+((x.score/max)*100).toFixed(1)}));postMessage({type:"progress",list:out});}if(!ok){const best=Array.from(STATE.best.entries()).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([k,score])=>({k,score}));postMessage({type:"done",list:best});STATE=null;return;}setTimeout(tick,0);}  
  `;
  const blob=new Blob([code],{type:'application/javascript'});
  worker=new Worker(URL.createObjectURL(blob));
  worker.onmessage=onWorkerMsg;
}

/* ===== Worker Events, UI, Start/Stop (wie gehabt) ===== */
// ... identisch zu vorher, nur nutzt er jetzt den gefixten Worker-Code ...

})();
</script>